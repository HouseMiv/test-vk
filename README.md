# Скрипт для тестирования производительности блочного устройства с помощью fio

## Описание

Этот скрипт автоматизирует процесс тестирования производительности блочного устройства с использованием утилиты `fio`. Он выполняет тесты чтения (randread) с различными значениями `iodepth` (глубина очереди ввода-вывода) и строит график зависимости задержки (latency) от `iodepth`.

## Функциональность

1.  **Запуск тестов fio:** Скрипт запускает серию тестов `fio` с различными значениями `iodepth` (1, 2, 4, 8, 16, 32, 64, 128, 256) для операции случайного чтения (`randread`).
2.  **Сбор и обработка результатов:** После каждого теста `fio` скрипт извлекает среднюю задержку из результатов, представленных в формате JSON.
3.  **Построение графика:** На основе собранных данных скрипт строит график зависимости задержки от `iodepth` с использованием библиотеки `matplotlib`. График отображает значения `iodepth` по оси X (в логарифмическом масштабе) и задержку в миллисекундах по оси Y.
4.  **Сохранение графика:** Скрипт сохраняет построенный график в файл, указанный пользователем.

## Требования

*   Python 3.6 или выше
*   Установленные библиотеки:
    *   `matplotlib`
    *   `argparse`
*   Утилита `fio` должна быть установлена и доступна в системе.

## Установка

1.  Установите необходимые библиотеки:

    ```
    pip install matplotlib argparse
    ```
2.  Убедитесь, что утилита `fio` установлена в вашей системе. Если нет, установите её с помощью вашего пакетного менеджера (например, `apt-get install fio` для Debian/Ubuntu).

## Использование

1.  Сохраните скрипт в файл, например, `fio_test.py`.
2.  Запустите скрипт с необходимыми аргументами командной строки:

    ```
    python fio_test.py --name <имя_теста> --filename <путь_к_файлу> --output <путь_к_файлу_графика>
    ```

    *   `--name`: Имя теста (например, "test1").
    *   `--filename`: Путь к файлу, который будет использоваться для тестирования (например, "/dev/sda").
    *   `--output`: Путь для сохранения графика (например, "latency.png").

    Пример:

    ```
    python fio_test.py --name my_test --filename /dev/sdb --output latency.png
    ```

## Аргументы командной строки

*   `--name` (обязательный): Имя теста. Используется для идентификации теста в результатах и на графике.
*   `--filename` (обязательный): Путь к файлу или блочному устройству, которое будет тестироваться. Убедитесь, что у вас есть права на чтение этого файла.
*   `--output` (обязательный): Путь к файлу, в который будет сохранен график зависимости задержки от iodepth.

## Принцип работы

1.  Скрипт принимает аргументы командной строки: имя теста, путь к файлу и путь для сохранения графика.
2.  Он проверяет существование указанного файла. Если файл не существует, скрипт завершается с ошибкой.
3.  Запускается серия тестов `fio` с различными значениями `iodepth`. Для каждого значения `iodepth` выполняется следующая команда `fio`:

    ```
    fio --name=<имя_теста> --filename=<путь_к_файлу> --ioengine=libaio --direct=1 --rw=randread --bs=4k --size=1G --numjobs=1 --iodepth=<значение_iodepth> --output-format=json
    ```

    *   `--name`: Имя задания fio.
    *   `--filename`: Файл или блочное устройство для тестирования.
    *   `--ioengine=libaio`: Используется асинхронный ввод-вывод (AIO).
    *   `--direct=1`: Отключает буферизацию операционной системы.
    *   `--rw=randread`: Задает операцию случайного чтения.
    *   `--bs=4k`: Размер блока 4KB.
    *   `--size=1G`: Общий размер данных для чтения 1GB.
    *   `--numjobs=1`: Количество параллельных заданий.
    *   `--iodepth`: Глубина очереди ввода-вывода.
    *   `--output-format=json`: Вывод результатов в формате JSON.
4.  Скрипт анализирует вывод `fio` в формате JSON и извлекает среднюю задержку чтения.
5.  После завершения всех тестов скрипт строит график зависимости задержки от `iodepth` и сохраняет его в указанный файл.

## Пример вывода графика
![output_graph](https://github.com/user-attachments/assets/4047f874-9c92-4096-93eb-5ccd764c3fe2)

График показывает зависимость задержки чтения от глубины очереди ввода-вывода (iodepth). Ось X представляет iodepth в логарифмическом масштабе, а ось Y представляет задержку в миллисекундах.


**Описание графика:**

Как видно из графика, при низких значениях iodepth (от 1 до 10) задержка остается относительно низкой и стабильной. Однако, начиная с iodepth около 32 и выше, наблюдается экспоненциальный рост задержки. Это связано с тем, что при увеличении глубины очереди ввода-вывода устройство хранения начинает перегружаться, что приводит к увеличению времени ожидания для каждого запроса.

Этот график позволяет оценить оптимальную глубину очереди ввода-вывода для конкретного устройства хранения и рабочей нагрузки. В данном случае, для достижения минимальной задержки рекомендуется использовать iodepth не более 32.


## Замечания

*   Убедитесь, что у вас есть права на чтение и запись в указанный файл.
*   Тестирование блочных устройств может занять продолжительное время.
*   Результаты могут варьироваться в зависимости от аппаратного обеспечения и конфигурации системы.
*   Не используйте этот скрипт на устройствах, содержащих важные данные, без предварительного резервного копирования.
